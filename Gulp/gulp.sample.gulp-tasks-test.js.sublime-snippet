<snippet>
  <content><![CDATA[
var gulp = require('gulp'),
  KarmaServer = require('karma').Server,
  inject = require('gulp-inject'),
  bowerFiles = require('main-bower-files'),
  runSequence = require('run-sequence'),
  plumber = require('gulp-plumber'),
  naturalSort = require('gulp-natural-sort'),
  angularFilesort = require('gulp-angular-filesort'),
  debug = require('gulp-debug');


function filepathForKarma (filepath, file, i, length) {
  if (filepath.endsWith(".json")) {
    return "{pattern: \"" + filepath + "\", watched: true, served: true, included: false},";
  } else {
    return '"' + filepath + '",';
  }
}

gulp.task('inject-test:vendor', function () {
  var injectOptions = {
    name: 'bower',
    relative: true,
    starttag: "// inject-bower",
    endtag: "// end-inject-bower",
    transform: filepathForKarma
  };

  var stream = gulp.src(settings.karmaConfig)
    .pipe(plumber({errorHandler: handleErrors}))
    .pipe(inject(
      gulp.src(
        bowerFiles("**/*.js", {checkExistence: true}), {read: false}
      ).pipe(debug()),
      injectOptions
    )).pipe(gulp.dest(settings.appRoot));

  return stream;
});

gulp.task('inject-test:${1:module-name}:app', function () {
  var injectOpts = {
    relative: true,
    starttag: "// inject-app",
    endtag: "// end-inject-app",
    transform: filepathForKarma,
  };

  return gulp.src(settings.karmaConfig)
    .pipe(plumber({errorHandler: handleErrors}))
    .pipe(inject(
      gulp.src([
        settings.src + '**/*.js',
        '!' + settings.bowerComponents + '**/*.js',
        settings.test + 'unit/**/*.spec.js'
      ]).pipe(naturalSort())
        .pipe(angularFilesort())
        .pipe(debug()),
      injectOpts))
    .pipe(gulp.dest(settings.appRoot));

});

gulp.task('inject-test:${1:module-name}:json', function () {
  var injectOpts = {
    relative: true,
    starttag: "// inject-json",
    endtag: "// end-inject-json",
    transform: filepathForKarma,
  };

  return gulp.src(settings.karmaConfig)
    .pipe(plumber({errorHandler: handleErrors}))
    .pipe(inject(
      gulp.src([
        settings.test + 'unit/**/*.json'
      ]).pipe(naturalSort())
        .pipe(debug()),
      injectOpts))
    .pipe(gulp.dest(settings.appRoot));
});

gulp.task('inject-test', function () {
  runSequence('inject-test:vendor', 'inject-test:${1:module-name}:app', 'inject-test:${1:module-name}:json');
});

gulp.task('test', function (done) {
  new KarmaServer({
    configFile: settings.karmaConfig,
    singleRun: true
  }, done).start();
});
]]></content>
  <tabTrigger>gpsample-gulp/tasks/test.js</tabTrigger>
  <scope>text.plain, source.js</scope>
</snippet>
